<script>
  // ======= 基本配置 =======
  const AI_BACKEND = 'replicate';               // 'replicate' | 'a1111' | 'openai'(占位)
  const AI_BACKEND_ENDPOINT = 'https://api.jaggerli.com';
  const REQUEST_TIMEOUT_MS = 20000;             // 20s 超时
  const FAST_RETRY_MAX_W = 896;                 // 超时后，自动再压缩一轮到 896px

  // ======= 现有 UI 变量 =======
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');
  const preview   = document.getElementById('preview');
  const matchBtn  = document.getElementById('matchBtn');
  const resetBtn  = document.getElementById('resetBtn');
  const resultBox = document.getElementById('result');
  const yourPhoto = document.getElementById('yourPhoto');
  const stylePhoto= document.getElementById('stylePhoto');
  const styleSkeleton = document.getElementById('styleSkeleton');
  const matchTitle= document.getElementById('matchTitle');
  const confidence= document.getElementById('confidence');
  const tags      = document.getElementById('tags');
  const tryAnother= document.getElementById('tryAnother');
  const useAI     = document.getElementById('useAI');
  const aiNote    = document.getElementById('aiNote');
  document.getElementById('year').textContent = new Date().getFullYear();

  // ======= 工具：压缩到最长边 1280、质量 0.85 =======
  async function downscaleDataURL(dataURL, maxW=1280, maxH=1280, quality=0.85){
    return new Promise(res=>{
      const img=new Image(); img.onload=()=>{
        const r=Math.min(maxW/img.width, maxH/img.height, 1);
        const w=Math.round(img.width*r), h=Math.round(img.height*r);
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        res(c.toDataURL('image/jpeg', quality));
      }; img.src=dataURL;
    });
  }

  // ======= 工具：fetch 超时封装 =======
  async function fetchWithTimeout(url, opts={}, ms=REQUEST_TIMEOUT_MS){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort('timeout'), ms);
    try{
      return await fetch(url, {...opts, signal: ctrl.signal});
    } finally { clearTimeout(id); }
  }

  // ======= 拖拽上传 =======
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.add('dragover');});
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.remove('dragover');});
  });
  dropzone.addEventListener('drop', e=>{
    const f = e.dataTransfer.files?.[0]; if(f) handleFile(f);
  });
  fileInput.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(f) handleFile(f);
  });

  function handleFile(file){
    if(!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const url = e.target.result;
      preview.innerHTML = `<img src="${url}" alt="preview">`;
      yourPhoto.src = url;
      resultBox.classList.remove('show');
    };
    reader.readAsDataURL(file);
  }

  // ======= 选项收集 / Prompt =======
  function getFilters(){
    const out={};
    document.querySelectorAll('.chips').forEach(g=>{
      const key=g.getAttribute('data-name');
      const act=g.querySelector('.chip.active');
      if(act) out[key]=act.textContent.trim();
    });
    return out;
  }
  function buildPrompt(filters){
    const len = filters.length || 'Medium';
    const sty = filters.style  || 'Professional';
    const shp = filters.shape  || 'Oval';
    const occ = filters.occasion || 'Work';
    return `Add a ${len.toLowerCase()} ${sty.toLowerCase()} hairstyle suitable for ${occ.toLowerCase()} to this person with a ${shp.toLowerCase()} face.
keep the same face identity and lighting, natural realistic photo, high detail hair strands, cinematic, 8k portrait.`;
  }
  function fakeMatchName(filters){
    const map = {
      Short: {Professional:'Clean Fade', Trendy:'Modern Quiff', Casual:'Messy Crop'},
      Medium:{Professional:'Side Part Classic', Trendy:'Textured Waves', Casual:'Relaxed Shag'},
      Long:  {Professional:'Layered Business', Trendy:'K-Pop Flow',    Casual:'Long Layers'}
    };
    const name = map[filters.length||'Medium']?.[filters.style||'Professional'] || 'Side Part Classic';
    const conf = Math.round(90 + Math.random()*8);
    return {name, conf};
  }

  // ======= 生成主流程（含超时 + 自动降级重试） =======
  matchBtn.addEventListener('click', async ()=>{
    if(!yourPhoto.src){
      dropzone.scrollIntoView({behavior:'smooth',block:'center'});
      dropzone.classList.add('dragover'); setTimeout(()=>dropzone.classList.remove('dragover'),700);
      return;
    }
    const t0 = performance.now();
    const filters = getFilters();
    const {name, conf} = fakeMatchName(filters);
    matchTitle.textContent = name;
    confidence.textContent = `· Confidence ~ ${conf}%`;
    tags.textContent = `#${filters.length||'Medium'} #${filters.style||'Professional'} ${filters.shape?('#'+filters.shape):''} ${filters.occasion?('#'+filters.occasion):''}`;
    resultBox.classList.add('show');

    stylePhoto.style.display='none';
    styleSkeleton.style.display='block';
    aiNote.style.display = useAI.checked ? 'inline' : 'none';

    try{
      let url;
      if(useAI.checked){
        // 先压缩到 1280
        url = await generateWithAI(yourPhoto.src, buildPrompt(filters), 1280, 0.85);

      }else{
        url = makePlaceholder('#cfe8d6,#eaf7ef');
      }
      stylePhoto.src = url;
    }catch(err){
      console.error(err);
      alert('AI 生成失败：' + (err?.message||err));
      stylePhoto.src = makePlaceholder('#cfe8d6,#eaf7ef');
    }finally{
      styleSkeleton.style.display='none';
      stylePhoto.style.display='block';
      document.getElementById('result').scrollIntoView({behavior:'smooth',block:'nearest'});
      const sec = ((performance.now()-t0)/1000).toFixed(1);
      confidence.textContent += ` · ${sec}s`;
    }
  });

  resetBtn.addEventListener('click', ()=>{
    fileInput.value=''; preview.innerHTML=''; yourPhoto.removeAttribute('src');
    resultBox.classList.remove('show'); document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
  });
  tryAnother.addEventListener('click', ()=>{ resultBox.classList.remove('show'); window.scrollTo({top:0,behavior:'smooth'}); });

  // ======= 前端 -> 代理：压缩 + 超时 + 降级重试 =======
  async function generateWithAI(dataURL, prompt, maxSide=1280, quality=0.85){
    // 压缩一轮
    const small = await downscaleDataURL(dataURL, maxSide, maxSide, quality);
    const b64 = small.split(',')[1];

    try{
      const res = await fetchWithTimeout(AI_BACKEND_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ backend: AI_BACKEND, prompt, image_base64: b64 })
      });
      if(!res.ok){
        const t = await res.text().catch(()=>res.statusText);
        throw new Error(`HTTP ${res.status} ${t}`);
      }
      const data = await res.json(); // { image_url | image_base64 }
      if(data.image_url)   return data.image_url;
      if(data.image_base64) return 'data:image/png;base64,'+data.image_base64;
      throw new Error('No image returned');
    }catch(err){
      // 如果是超时或网络错误，自动降级再试一次（896px）
      if(String(err).includes('timeout') || String(err).includes('Failed to fetch')){
        const smaller = await downscaleDataURL(dataURL, FAST_RETRY_MAX_W, FAST_RETRY_MAX_W, 0.8);
        const b64b = smaller.split(',')[1];
        const res2 = await fetchWithTimeout(AI_BACKEND_ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ backend: AI_BACKEND, prompt, image_base64: b64b })
        }, REQUEST_TIMEOUT_MS);
        if(!res2.ok){
          const t = await res2.text().catch(()=>res2.statusText);
          throw new Error(`(retry) HTTP ${res2.status} ${t}`);
        }
        const data2 = await res2.json();
        if(data2.image_url)   return data2.image_url;
        if(data2.image_base64) return 'data:image/png;base64,'+data2.image_base64;
        throw new Error('(retry) No image returned');
      }
      throw err;
    }
  }

  // ======= 简单占位图 =======
  function makePlaceholder(grad){
    const [c1,c2]=grad.split(',');
    const cvs=document.createElement('canvas'); cvs.width=800; cvs.height=1000;
    const ctx=cvs.getContext('2d');
    const g=ctx.createLinearGradient(0,0,800,1000); g.addColorStop(0,c1.trim()); g.addColorStop(1,(c2||c1).trim());
    ctx.fillStyle=g; ctx.fillRect(0,0,800,1000);
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.font='bold 44px system-ui,-apple-system,Segoe UI'; ctx.textAlign='center';
    ctx.fillText('AI Style (placeholder)', 400,520);
    return cvs.toDataURL('image/png');
  }

  // ======= 单选逻辑 =======
  document.querySelectorAll('.chips').forEach(group=>{
    group.addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      group.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });
  });
</script>
