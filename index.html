<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hairstyle Matcher | AI Powered (WebGPU 本地运行)</title>
<meta name="description" content="Upload a photo, choose your preferences, and get an AI-generated hairstyle suggestion — runs fully in your browser with WebGPU.">
<style>
  :root{
    --bg:#eef5ff; --bg2:#f8fbff; --card:#fff; --muted:#6b7280; --text:#1f2937;
    --primary:#2b6cb0; --accent:#7aa8ff; --border:#dbe3f0; --shadow:0 16px 40px rgba(16,42,87,.12);
    --ring:0 0 0 8px rgba(43,108,176,.12); --radius:18px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
    background: radial-gradient(1200px 600px at -10% -10%, rgba(122,168,255,.25), transparent),
                linear-gradient(135deg, var(--bg) 0%, var(--bg2) 70%, #fff 100%);}
  a{color:var(--primary);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:28px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:44px;height:44px;border-radius:12px;background:var(--primary);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow)}
  nav{display:flex;gap:14px;color:var(--muted)} nav a{padding:6px 10px;border-radius:999px} nav a:hover{background:#eaf2ff}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:22px} @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
  .card h2{margin:0 0 12px} .muted{color:var(--muted)} .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .uploader{border:2px dashed #c9d7f0;border-radius:16px;padding:20px;text-align:center;background:linear-gradient(180deg,#fff,#f7fbff);transition:.25s}
  .uploader.dragover{border-color:var(--primary);box-shadow:var(--ring)} .uploader input{display:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;
       box-shadow:0 8px 18px rgba(43,108,176,.25)} .btn.secondary{background:#eef4ff;color:#274472}
  .opt{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))} @media(max-width:560px){.opt{grid-template-columns:1fr}}
  .opt-group{background:#f7fbff;border:1px solid var(--border);border-radius:14px;padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap} .chip{border:1px solid #cfe0ff;background:#fff;color:#274472;padding:6px 10px;border-radius:999px;cursor:pointer}
  .chip.active{background:#e8f0ff;border-color:var(--primary);color:#2b6cb0;box-shadow:var(--ring)}
  .preview{margin-top:14px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
  .preview img{max-width:240px;max-height:240px;object-fit:cover;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .result{display:none;margin-top:14px;border:1px dashed #d7e4ff;border-radius:14px;padding:14px;background:linear-gradient(180deg,#fff,#f7fbff)}
  .result.show{display:block}
  .match-top{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .match-badge{padding:6px 10px;border-radius:999px;background:#eef4ff;border:1px solid #cfe0ff;color:#274472}
  .match-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px} @media(max-width:720px){.match-grid{grid-template-columns:1fr}}
  .match-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .match-card img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:10px;border:1px solid #edf1f7}
  .skeleton{width:100%;aspect-ratio:4/5;border-radius:10px;background:linear-gradient(90deg,#eef2f7 0%,#f7f9fc 50%,#eef2f7 100%);background-size:200% 100%;animation:sk 1.2s infinite linear}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .toggle input{appearance:none;width:44px;height:26px;border-radius:999px;position:relative;background:#cfdaf2;outline:none;cursor:pointer}
  .toggle input:checked{background:#2b6cb0}
  .toggle input::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s}
  .toggle input:checked::after{left:21px}
  .loader{display:none;align-items:center;gap:8px;font-size:14px;color:#274472}
  .loader.spin::before{content:"";width:14px;height:14px;border-radius:50%;border:3px solid #cfe0ff;border-top-color:#2b6cb0;display:inline-block;animation:rot .9s linear infinite}
  @keyframes rot{to{transform:rotate(360deg)}}
  footer{margin:24px 0 6px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">H</div>
      <div>
        <h1 style="margin:0 0 4px">Hairstyle Matcher</h1>
        <div class="muted">Upload · Choose · <strong>AI Generate (WebGPU)</strong></div>
      </div>
    </div>
    <nav><a href="#upload">Upload</a><a href="#result">Result</a></nav>
  </header>

  <div class="grid">
    <!-- 左：上传与选项 -->
    <section class="card" id="upload">
      <h2>1) Upload & Preferences</h2>
      <div class="uploader" id="dropzone">
        <p style="margin:0 0 10px"><strong>Drag & drop</strong> your photo here, or</p>
        <label class="btn"><input id="fileInput" type="file" accept="image/*"> Choose a Photo</label>
        <div class="muted" style="font-size:13px;margin-top:6px">
          所有图片格式（JPG/PNG/WebP/AVIF…）均可。<br>
          首次加载会下载模型（较大），请耐心等候一次，后续走缓存。
        </div>
        <div class="preview" id="preview"></div>
      </div>

      <div class="opt" style="margin-top:14px">
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Length</div>
          <div class="chips" data-name="length"><span class="chip">Short</span><span class="chip">Medium</span><span class="chip">Long</span></div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Style</div>
          <div class="chips" data-name="style"><span class="chip">Professional</span><span class="chip">Trendy</span><span class="chip">Casual</span></div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Face Shape</div>
          <div class="chips" data-name="shape"><span class="chip">Oval</span><span class="chip">Round</span><span class="chip">Square</span><span class="chip">Heart</span></div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Occasion</div>
          <div class="chips" data-name="occasion"><span class="chip">Work</span><span class="chip">Date</span><span class="chip">Event</span></div>
        </div>
      </div>

      <div class="inline" style="margin-top:14px">
        <button class="btn" id="matchBtn">Find Match</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
        <div class="loader" id="loader"><span class="spin"></span><span id="loadText">Loading model… 首次加载可能较慢</span></div>
      </div>

      <div id="result" class="result" aria-live="polite">
        <div class="match-top">
          <span class="match-badge">Your Match</span>
          <span id="matchTitle" style="font-weight:700">—</span>
          <span class="muted" id="confidence"></span>
          <span class="muted" id="aiNote" style="display:none">· Generated locally</span>
        </div>
        <div class="match-grid" style="margin-top:8px">
          <div class="match-card"><div class="muted" style="margin-bottom:6px">Your Photo</div><img id="yourPhoto" alt="Your photo"></div>
          <div class="match-card">
            <div class="muted" style="margin-bottom:6px">Suggested Style</div>
            <div id="styleSkeleton" class="skeleton" style="display:none"></div>
            <img id="stylePhoto" alt="Suggested hairstyle" style="display:none">
            <div style="margin-top:8px" class="muted" id="tags"></div>
          </div>
        </div>
        <div class="inline" style="margin-top:10px"><button class="btn secondary" id="tryAnother">Try Another</button></div>
      </div>
    </section>

    <!-- 右：说明 -->
    <aside class="card">
      <h2>How it works</h2>
      <ol style="margin:8px 0 0 18px">
        <li>Everything runs <em>in your browser</em> with WebGPU/WASM（无后端、无限点击）。</li>
        <li>Upload → choose options → click “Find Match”.</li>
        <li>首次会下载模型分片（缓存到 IndexedDB）。</li>
      </ol>
      <p class="muted" style="margin:10px 0 0">提示：若设备不支持 WebGPU，会自动回退到 WASM（更慢）。</p>
    </aside>
  </div>

  <footer>© <span id="year"></span> Hairstyle Matcher · Local AI</footer>
</div>

<!-- ========= 本地推理：Transformers.js / WebGPU ========= -->
<script type="module">
  document.getElementById('year').textContent = new Date().getFullYear();

  // ============ 引入 transformers.js 并准备管线 ============
  import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@3.0.0";

  // 缓存到 IndexedDB，减轻二次加载
  env.cacheDir = 'indexeddb://transformers';
  // onnxruntime web 依赖（自动选择 wasm/webgpu）
  env.backends.onnx.wasm.wasmPaths = "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.0/dist/";
  env.allowRemoteModels = true;

  const loader = document.getElementById('loader');
  const loadText = document.getElementById('loadText');

  // 检查 WebGPU 支持（不支持也能跑 WASM）
  if (!('gpu' in navigator)) {
    loader.style.display = 'flex';
    loadText.textContent = '未检测到 WebGPU，将回退到较慢的 WebAssembly 模式';
  }

  // 预加载模型管线（sd-turbo：更快的图生图）
  loader.style.display = 'flex';
  loadText.textContent = 'Loading Stable Diffusion Turbo… 首次加载较慢，仅需一次';
  window.__pipelinesReady = (async () => {
    try {
      window.img2img = await pipeline(
        "image-to-image",
        "Xenova/stable-diffusion-turbo",   // 可换 "Xenova/stable-diffusion-1.5"
        { quantized: true }
      );
      loadText.textContent = 'Model ready ✓';
      setTimeout(()=> loader.style.display='none', 600);
    } catch (e) {
      loadText.textContent = '模型加载失败：' + e?.message;
      console.error(e);
    }
  })();

  // ============ DOM 元素 ============
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');
  const preview   = document.getElementById('preview');
  const matchBtn  = document.getElementById('matchBtn');
  const resetBtn  = document.getElementById('resetBtn');
  const resultBox = document.getElementById('result');
  const yourPhoto = document.getElementById('yourPhoto');
  const stylePhoto= document.getElementById('stylePhoto');
  const styleSkeleton = document.getElementById('styleSkeleton');
  const matchTitle= document.getElementById('matchTitle');
  const confidence= document.getElementById('confidence');
  const tags      = document.getElementById('tags');
  const tryAnother= document.getElementById('tryAnother');
  const aiNote    = document.getElementById('aiNote');

  // ============ 工具函数 ============
  async function dataURLToImageBitmap(dataURL){
    const blob = await (await fetch(dataURL)).blob();
    return await createImageBitmap(blob);
  }
  function bitmapToCanvas(imgBitmap, target=768){
    const r = Math.min(target / imgBitmap.width, target / imgBitmap.height, 1);
    const w = Math.round(imgBitmap.width * r), h = Math.round(imgBitmap.height * r);
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,w,h); ctx.drawImage(imgBitmap, 0, 0, w, h);
    return c;
  }
  function makePlaceholder(grad='#cfe8d6,#eaf7ef'){
    const [c1,c2]=grad.split(',');
    const cvs=document.createElement('canvas'); cvs.width=800; cvs.height=1000;
    const ctx=cvs.getContext('2d');
    const g=ctx.createLinearGradient(0,0,800,1000); g.addColorStop(0,c1.trim()); g.addColorStop(1,(c2||c1).trim());
    ctx.fillStyle=g; ctx.fillRect(0,0,800,1000);
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.font='bold 44px system-ui,-apple-system,Segoe UI'; ctx.textAlign='center';
    ctx.fillText('AI Style (local placeholder)', 400,520);
    return cvs.toDataURL('image/png');
  }

  // 选项收集 + prompt
  function getFilters(){
    const out={};
    document.querySelectorAll('.chips').forEach(g=>{
      const key=g.getAttribute('data-name');
      const act=g.querySelector('.chip.active');
      if(act) out[key]=act.textContent.trim();
    });
    return out;
  }
  function buildPrompt(f){
    const len = f.length || 'Medium';
    const sty = f.style  || 'Professional';
    const shp = f.shape  || 'Oval';
    const occ = f.occasion || 'Work';
    // 尽量简洁明确，有助 Turbo 收敛
    return `short: ${len.toLowerCase()} | style: ${sty.toLowerCase()} | for ${occ.toLowerCase()} | ${shp.toLowerCase()} face. clean fade, neat side part, natural color, realistic photo, detailed hair strands`;
  }
  function fakeMatchName(f){
    const map={Short:{Professional:'Clean Fade',Trendy:'Modern Quiff',Casual:'Messy Crop'},
               Medium:{Professional:'Side Part Classic',Trendy:'Textured Waves',Casual:'Relaxed Shag'},
               Long:{Professional:'Layered Business',Trendy:'K-Pop Flow',Casual:'Long Layers'}};
    const name = map[f.length||'Medium']?.[f.style||'Professional'] || 'Side Part Classic';
    const conf = Math.round(90 + Math.random()*8);
    return {name, conf};
  }

  // ============ 上传/拖拽 ============
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.add('dragover');});
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.remove('dragover');});
  });
  dropzone.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
  fileInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

  function handleFile(file){
    if(!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const url = e.target.result;
      preview.innerHTML = `<img src="${url}" alt="preview">`;
      yourPhoto.src = url;
      resultBox.classList.remove('show');
    };
    reader.readAsDataURL(file);
  }

  // ============ 本地生成主流程 ============
  async function generateWithAI_Local(dataURL, prompt){
    await window.__pipelinesReady; // 确保模型已就绪
    const t0 = performance.now();
    const img = await dataURLToImageBitmap(dataURL);
    const initCanvas = bitmapToCanvas(img, 768);

    // sd-turbo 建议低 guidance + 少步数
    const result = await window.img2img({
      image: initCanvas,
      prompt,
      strength: 0.6,              // 越小越贴近原图（发型变化更少）
      guidance_scale: 2.0,        // 低一些更快收敛
      num_inference_steps: 4      // 1~4 步足够快
    });

    const outCanvas = result.images?.[0]; // HTMLCanvasElement
    const sec = ((performance.now()-t0)/1000).toFixed(1);
    return { dataURL: outCanvas.toDataURL('image/png'), seconds: sec };
  }

  // ============ 交互 ============
  matchBtn.addEventListener('click', async ()=>{
    if(!yourPhoto.src){
      dropzone.scrollIntoView({behavior:'smooth',block:'center'});
      dropzone.classList.add('dragover'); setTimeout(()=>dropzone.classList.remove('dragover'),700);
      return;
    }
    const filters = getFilters();
    const {name, conf} = fakeMatchName(filters);
    matchTitle.textContent = name;
    confidence.textContent = `· Confidence ~ ${conf}%`;
    tags.textContent = `#${filters.length||'Medium'} #${filters.style||'Professional'} ${filters.shape?('#'+filters.shape):''} ${filters.occasion?('#'+filters.occasion):''}`;
    resultBox.classList.add('show');

    stylePhoto.style.display='none';
    styleSkeleton.style.display='block';
    aiNote.style.display = 'inline';

    try{
      const { dataURL, seconds } = await generateWithAI_Local(yourPhoto.src, buildPrompt(filters));
      stylePhoto.src = dataURL;
      confidence.textContent += ` · ${seconds}s`;
    }catch(err){
      console.error(err);
      alert('本地生成失败：' + (err?.message||err));
      stylePhoto.src = makePlaceholder();
    }finally{
      styleSkeleton.style.display='none';
      stylePhoto.style.display='block';
      document.getElementById('result').scrollIntoView({behavior:'smooth',block:'nearest'});
    }
  });

  resetBtn.addEventListener('click', ()=>{
    fileInput.value=''; preview.innerHTML=''; yourPhoto.removeAttribute('src');
    resultBox.classList.remove('show'); document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
  });

  tryAnother.addEventListener('click', ()=>{
    resultBox.classList.remove('show');
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // 单选逻辑
  document.querySelectorAll('.chips').forEach(group=>{
    group.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      group.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });
  });
</script>
</body>
</html>
