<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hairstyle Matcher | AI Powered</title>
<meta name="description" content="Upload a photo, choose preferences, and get an AI-generated hairstyle suggestion.">
<style>
  :root{
    --bg:#eef5ff; --bg2:#f8fbff; --card:#fff; --muted:#6b7280; --text:#1f2937;
    --primary:#2b6cb0; --border:#dbe3f0; --shadow:0 16px 40px rgba(16,42,87,.12); --radius:18px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
    background: radial-gradient(1200px 600px at -10% -10%, rgba(122,168,255,.25), transparent),
                linear-gradient(135deg, var(--bg) 0%, var(--bg2) 70%, #fff 100%);}
  .wrap{max-width:1100px;margin:0 auto;padding:28px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:44px;height:44px;border-radius:12px;background:var(--primary);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow)}
  nav{display:flex;gap:14px;color:var(--muted)} nav a{padding:6px 10px;border-radius:999px} nav a:hover{background:#eaf2ff}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:22px} @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
  .muted{color:var(--muted)}
  .uploader{border:2px dashed #c9d7f0;border-radius:16px;padding:20px;text-align:center;background:linear-gradient(180deg,#fff,#f7fbff);transition:.25s}
  .uploader.dragover{border-color:var(--primary);box-shadow:0 0 0 8px rgba(43,108,176,.12)}
  .uploader input{display:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;box-shadow:0 8px 18px rgba(43,108,176,.25)}
  .btn.secondary{background:#eef4ff;color:#274472}
  .opt{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))} @media(max-width:560px){.opt{grid-template-columns:1fr}}
  .opt-group{background:#f7fbff;border:1px solid var(--border);border-radius:14px;padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #cfe0ff;background:#fff;color:#274472;padding:6px 10px;border-radius:999px;cursor:pointer}
  .chip.active{background:#e8f0ff;border-color:var(--primary);color:#2b6cb0;box-shadow:0 0 0 8px rgba(43,108,176,.12)}
  .preview{margin-top:14px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
  .preview img{max-width:240px;max-height:240px;object-fit:cover;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .result{display:none;margin-top:14px;border:1px dashed #d7e4ff;border-radius:14px;padding:14px;background:linear-gradient(180deg,#fff,#f7fbff)}
  .result.show{display:block}
  .match-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px} @media(max-width:720px){.match-grid{grid-template-columns:1fr}}
  .match-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .match-card img{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:10px;border:1px solid #edf1f7}
  .skeleton{width:100%;aspect-ratio:4/5;border-radius:10px;background:linear-gradient(90deg,#eef2f7 0%,#f7f9fc 50%,#eef2f7 100%);background-size:200% 100%;animation:sk 1.2s infinite linear}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .toggle input{appearance:none;width:44px;height:26px;border-radius:999px;position:relative;background:#cfdaf2;outline:none;cursor:pointer}
  .toggle input:checked{background:#2b6cb0}
  .toggle input::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s}
  .toggle input:checked::after{left:21px}
  footer{margin:24px 0 6px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">H</div>
      <div>
        <h1 style="margin:0 0 4px">Hairstyle Matcher</h1>
        <div class="muted">Upload · Choose · <strong>AI Generate</strong></div>
      </div>
    </div>
    <nav><a href="#upload">Upload</a><a href="#result">Result</a></nav>
  </header>

  <div class="grid">
    <section class="card" id="upload">
      <h2>1) Upload & Preferences</h2>
      <div class="uploader" id="dropzone">
        <p style="margin:0 0 10px"><strong>Drag & drop</strong> your photo here, or</p>
        <label class="btn"><input id="fileInput" type="file" accept="image/*"> Choose a Photo</label>
        <div class="muted" style="font-size:13px;margin-top:6px">Processed locally · Your image isn’t uploaded unless AI is enabled</div>
        <div class="preview" id="preview"></div>
      </div>

      <div class="opt" style="margin-top:14px">
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Length</div>
          <div class="chips" data-name="length">
            <span class="chip">Short</span><span class="chip">Medium</span><span class="chip">Long</span>
          </div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Style</div>
          <div class="chips" data-name="style">
            <span class="chip">Professional</span><span class="chip">Trendy</span><span class="chip">Casual</span>
          </div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Face Shape</div>
          <div class="chips" data-name="shape">
            <span class="chip">Oval</span><span class="chip">Round</span><span class="chip">Square</span><span class="chip">Heart</span>
          </div>
        </div>
        <div class="opt-group">
          <div class="muted" style="margin-bottom:8px">Occasion</div>
          <div class="chips" data-name="occasion">
            <span class="chip">Work</span><span class="chip">Date</span><span class="chip">Event</span>
          </div>
        </div>
      </div>

      <div class="inline" style="margin-top:14px">
        <button class="btn" id="matchBtn">Find Match</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
        <label class="toggle" title="Use AI to generate a new hairstyle image">
          <input type="checkbox" id="useAI" checked><span class="muted">Use AI 生成</span>
        </label>
      </div>

      <div id="result" class="result" aria-live="polite">
        <div class="match-top">
          <span class="match-badge">Your Match</span>
          <span id="matchTitle" style="font-weight:700">—</span>
          <span class="muted" id="confidence"></span>
          <span class="muted" id="aiNote" style="display:none">· AI generated</span>
        </div>
        <div class="match-grid">
          <div class="match-card">
            <div class="muted" style="margin-bottom:6px">Your Photo</div>
            <img id="yourPhoto" alt="Your photo">
          </div>
          <div class="match-card">
            <div class="muted" style="margin-bottom:6px">Suggested Style</div>
            <div id="styleSkeleton" class="skeleton" style="display:none"></div>
            <img id="stylePhoto" alt="Suggested hairstyle" style="display:none">
            <div style="margin-top:8px" class="muted" id="tags"></div>
          </div>
        </div>
        <div class="inline" style="margin-top:10px"><button class="btn secondary" id="tryAnother">Try Another</button></div>
      </div>
    </section>

    <aside class="card">
      <h2>How it works</h2>
      <ol style="margin:8px 0 0 18px">
        <li>Preview happens <em>locally</em>.</li>
        <li>Choose length, style, face shape, occasion.</li>
        <li>Click <strong>Find Match</strong>. If <em>Use AI</em> is on, we send your photo to your backend and get a generated image.</li>
      </ol>
      <p class="muted" style="margin:10px 0 0">Hosting: GitHub Pages + your Cloudflare/Colab backend (keeps API keys secret).</p>
    </aside>
  </div>

  <footer>© <span id="year"></span> Hairstyle Matcher</footer>
</div>

<script>
  /* ========= FRONT-END CONFIG (EDIT THESE) ========= */
  // 1) Replace with your tunnel/worker URL (no trailing slash)
  const AI_BACKEND_ENDPOINT = 'https://genetics-combine-king-transportation.trycloudflare.com';
  // 2) Backend type
  const AI_BACKEND = 'replicate'; // 'replicate' | 'a1111'
  // 3) Polling & timeouts
  const REQUEST_TIMEOUT_MS = 65000;
  const POLL_INTERVAL_MS   = 1200;
  const FAST_RETRY_MAX_W   = 768;  // fallback size
  document.getElementById('year').textContent = new Date().getFullYear();

  /* ========== Elements ========== */
  const fileInput = document.getElementById('fileInput');
  const dropzone  = document.getElementById('dropzone');
  const preview   = document.getElementById('preview');
  const matchBtn  = document.getElementById('matchBtn');
  const resetBtn  = document.getElementById('resetBtn');
  const resultBox = document.getElementById('result');
  const yourPhoto = document.getElementById('yourPhoto');
  const stylePhoto= document.getElementById('stylePhoto');
  const styleSkeleton = document.getElementById('styleSkeleton');
  const matchTitle= document.getElementById('matchTitle');
  const confidence= document.getElementById('confidence');
  const tags      = document.getElementById('tags');
  const tryAnother= document.getElementById('tryAnother');
  const useAI     = document.getElementById('useAI');
  const aiNote    = document.getElementById('aiNote');

  /* ========== Utils ========== */
  async function downscaleDataURL(dataURL, maxW=1280, maxH=1280, quality=0.92){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        const r = Math.min(maxW/img.width, maxH/img.height, 1);
        const w = Math.round(img.width*r), h = Math.round(img.height*r);
        const c = document.createElement('canvas'); c.width=w; c.height=h;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(img,0,0,w,h);
        // unify to PNG so ANY decodable input type works (jpg/png/webp/avif…)
        resolve(c.toDataURL('image/png', quality));
      };
      img.onerror = ()=>reject(new Error('This image type cannot be decoded by your browser.'));
      img.src = dataURL;
    });
  }
  async function safeFetch(url, opts){
    try{ return await fetch(url, opts); }
    catch{ throw new Error('Failed to fetch'); }
  }

  /* ========== Drag & drop / file ========== */
  ['dragenter','dragover'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.add('dragover');});
  });
  ['dragleave','drop'].forEach(evt=>{
    dropzone.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dropzone.classList.remove('dragover');});
  });
  dropzone.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
  fileInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });
  function handleFile(file){
    if(!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const url = e.target.result;
      preview.innerHTML = `<img src="${url}" alt="preview">`;
      yourPhoto.src = url;
      resultBox.classList.remove('show');
    };
    reader.readAsDataURL(file);
  }

  /* ========== Prompt bits ========== */
  function getFilters(){
    const out={};
    document.querySelectorAll('.chips').forEach(g=>{
      const key=g.getAttribute('data-name');
      const act=g.querySelector('.chip.active');
      if(act) out[key]=act.textContent.trim();
    });
    return out;
  }
  function buildPrompt(f){
    const len = f.length || 'Medium';
    const sty = f.style  || 'Professional';
    const shp = f.shape  || 'Oval';
    const occ = f.occasion || 'Work';
    return `Add a ${len.toLowerCase()} ${sty.toLowerCase()} hairstyle suitable for ${occ.toLowerCase()} to this person with a ${shp.toLowerCase()} face. keep the same face identity and lighting, natural realistic photo, high detail hair strands, cinematic, 8k portrait.`;
  }
  function fakeMatchName(f){
    const map={Short:{Professional:'Clean Fade',Trendy:'Modern Quiff',Casual:'Messy Crop'},
               Medium:{Professional:'Side Part Classic',Trendy:'Textured Waves',Casual:'Relaxed Shag'},
               Long:{Professional:'Layered Business',Trendy:'K-Pop Flow',Casual:'Long Layers'}};
    const name = map[f.length||'Medium']?.[f.style||'Professional'] || 'Side Part Classic';
    const conf = Math.round(90 + Math.random()*8);
    return {name, conf};
  }
  document.querySelectorAll('.chips').forEach(group=>{
    group.addEventListener('click', e=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      group.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
    });
  });

  /* ========== Generate flow (create + poll) ========== */
  matchBtn.addEventListener('click', async ()=>{
    if(!yourPhoto.src){
      dropzone.scrollIntoView({behavior:'smooth',block:'center'});
      dropzone.classList.add('dragover'); setTimeout(()=>dropzone.classList.remove('dragover'),700);
      return;
    }
    const t0 = performance.now();
    const f = getFilters();
    const {name, conf} = fakeMatchName(f);
    matchTitle.textContent = name;
    confidence.textContent = `· Confidence ~ ${conf}%`;
    tags.textContent = `#${f.length||'Medium'} #${f.style||'Professional'} ${f.shape?('#'+f.shape):''} ${f.occasion?('#'+f.occasion):''}`;
    resultBox.classList.add('show');

    stylePhoto.style.display='none';
    styleSkeleton.style.display='block';
    aiNote.style.display = useAI.checked ? 'inline' : 'none';

    try{
      let url;
      if(useAI.checked){
        url = await generateWithAI(yourPhoto.src, buildPrompt(f), 1280, 0.92);
      }else{
        url = makePlaceholder('#cfe8d6,#eaf7ef');
      }
      stylePhoto.src = url;
    }catch(err){
      console.error(err);
      alert('AI 生成失败：' + (err?.message||err));
      stylePhoto.src = makePlaceholder('#cfe8d6,#eaf7ef');
    }finally{
      styleSkeleton.style.display='none';
      stylePhoto.style.display='block';
      document.getElementById('result').scrollIntoView({behavior:'smooth',block:'nearest'});
      const sec=((performance.now()-t0)/1000).toFixed(1);
      confidence.textContent += ` · ${sec}s`;
    }
  });

  resetBtn.addEventListener('click', ()=>{
    fileInput.value=''; preview.innerHTML=''; yourPhoto.removeAttribute('src');
    resultBox.classList.remove('show'); document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
  });
  tryAnother.addEventListener('click', ()=>{ resultBox.classList.remove('show'); window.scrollTo({top:0,behavior:'smooth'}); });

  async function generateWithAI(dataURL, prompt, maxSide=1280, quality=0.92){
    // compress + unify => PNG
    const small = await downscaleDataURL(dataURL, maxSide, maxSide, quality);
    const b64   = small.split(',')[1];

    // create
    let create = await safeFetch(`${AI_BACKEND_ENDPOINT}/create`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ backend: AI_BACKEND, prompt, image_base64: b64 })
    });

    // fallback create (smaller)
    if(!create.ok){
      const smaller = await downscaleDataURL(dataURL, FAST_RETRY_MAX_W, FAST_RETRY_MAX_W, 0.9);
      const b64b = smaller.split(',')[1];
      create = await safeFetch(`${AI_BACKEND_ENDPOINT}/create`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ backend: AI_BACKEND, prompt, image_base64: b64b })
      });
    }
    if(!create.ok) throw new Error("create: " + (await create.text().catch(()=>create.statusText)));
    const cj = await create.json();
    if(!cj.id) throw new Error("create: no id");

    // poll
    const start = Date.now();
    while(true){
      const r = await safeFetch(`${AI_BACKEND_ENDPOINT}/status/${cj.id}`);
      if(!r.ok) throw new Error("status: " + (await r.text().catch(()=>r.statusText)));
      const s = await r.json();
      if(s.status === 'succeeded'){
        if(s.image_url) return s.image_url;
        throw new Error("status: no image_url");
      }
      if(Date.now() - start > REQUEST_TIMEOUT_MS) throw new Error("timeout");
      await new Promise(res=>setTimeout(res, POLL_INTERVAL_MS));
    }
  }

  function makePlaceholder(grad){
    const [c1,c2]=grad.split(',');
    const cvs=document.createElement('canvas'); cvs.width=800; cvs.height=1000;
    const ctx=cvs.getContext('2d');
    const g=ctx.createLinearGradient(0,0,800,1000); g.addColorStop(0,c1.trim()); g.addColorStop(1,(c2||c1).trim());
    ctx.fillStyle=g; ctx.fillRect(0,0,800,1000);
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.font='bold 44px system-ui,-apple-system,Segoe UI'; ctx.textAlign='center';
    ctx.fillText('AI Style (placeholder)', 400,520);
    return cvs.toDataURL('image/png');
  }
</script>
</body>
</html>
